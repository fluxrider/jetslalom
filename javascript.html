<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jet Slalom Resurrected</title>
<script>
function go_fullscreen() { const canvas_element = document.getElementById("canvas"); if(canvas_element.requestFullScreen) { canvas_element.requestFullScreen(); } else if(canvas_element.webkitRequestFullScreen) { canvas_element.webkitRequestFullScreen(); } else if(canvas_element.mozRequestFullScreen) { canvas_element.mozRequestFullScreen(); } }
function currentTimeMillis() { var now = new Date(); return Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(),  now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds(), now.getUTCMilliseconds()); }

var ship_0, ship_1;
const explosion = new Audio('res/explosion.wav');

var target_dt = 55;
var delay = target_dt;
var t0, t1;
var original_filter;

var mouse_held = false;
var mouse_x, mouse_y;
function on_mouse_down(e) {
  mouse_x = e.offsetX;
  mouse_y = e.offsetY;
  mouse_held = true;
}
function on_mouse_up(e) {
  mouse_held = false;
}

function on_mouse_move(e) {
  if(mouse_held) {
    mouse_x = e.offsetX;
    mouse_y = e.offsetY;
  }
}

async function app_start() {
  const canvas_element = document.getElementById("canvas");
  canvas_element.onmousedown = on_mouse_down;
  canvas_element.onmouseup = on_mouse_up;
  canvas_element.onmousemove = on_mouse_move;
  const canvas = canvas_element.getContext("2d");
  original_filter = canvas.filter;

  // load assets
  ship_0 = new Image(); ship_0.src = "res/jiki.gif"; await ship_0.decode();
  ship_1 = new Image(); ship_1.src = "res/jiki2.gif"; await ship_1.decode();

  // start draw loop
  t0 = currentTimeMillis(); t1 = t0;
  app_draw();
  // explosion.play(); TODO
}

function app_draw() {
  t0 = t1; t1 = currentTimeMillis(); let dt = t1 - t0;
  const canvas_element = document.getElementById("canvas");
  const width = canvas_element.width; const height = canvas_element.height;
  const canvas = canvas_element.getContext("2d");
  const logical_width = 320; const logical_height = 200;
  canvas.imageSmoothingEnabled = false;

  // the svg trick to disable anti-alias of shapes does not work on an offscreen surface, so I scale the real one instead
  canvas.filter = 'url(#remove-alpha)';
  canvas.scale(4,4); draw_scene(canvas, logical_width, logical_height);
  
  // text overlay
  canvas.filter = original_filter; canvas.scale(.25,.25);
  canvas.fillStyle = "rgb(0 0 0)";
  canvas.font = "48px serif";
  const msg = mouse_held? (mouse_x + " " + mouse_y) : "no mouse";
  const fm = canvas.measureText(msg);
  canvas.fillText(msg, 0, height);
  canvas.fillText(msg, width - fm.width, height);
  canvas.fillText(msg, 0, fm.actualBoundingBoxAscent);

  // request another draw later
  if(dt > target_dt) { delay--; } // framerate too low, try faster
  if(dt < target_dt) { delay++; } // framerate too high, try slower
  if(delay < 1) delay = 1;
  window.setTimeout(app_draw, delay);
}

function draw_scene(canvas, width, height) {
  canvas.fillStyle = "rgb(0 196 196)";
  canvas.fillRect(0, 0, width, height);

  canvas.fillStyle = "rgb(255 0 0)";
  canvas.beginPath();
  canvas.moveTo(30, 20);
  canvas.lineTo(90, 20);
  canvas.lineTo(195, 70);
  canvas.lineTo(15, 90);
  canvas.closePath();
  canvas.fill();

  canvas.drawImage(ship_0, (width - ship_0.width)/2, (height - ship_0.height) / 2);
  canvas.drawImage(ship_0, (width - 2*ship_0.width)/2, (height - 2*ship_0.height), 2*ship_0.width, 2*ship_0.height);
}

</script>
</head>
<body onload="app_start();">
<p><button onclick="go_fullscreen();">Go Fullscreen</button>&emsp;<a href="https://github.com/fluxrider/jetslalom">Github</a></p>
<canvas id="canvas" width="1280" height="800" style="border: 3px solid black; image-rendering: pixelated;"></canvas>
<!-- hack to disable anti-alias drawing: https://stackoverflow.com/questions/4261090/html5-canvas-and-anti-aliasing -->
<svg width="0" height="0" style="position:absolute;z-index:-1;"><defs><filter id="remove-alpha" x="0" y="0" width="100%" height="100%"><feComponentTransfer><feFuncA type="discrete" tableValues="0 1"></feFuncA></feComponentTransfer></filter></defs></svg>
</body>
</html>